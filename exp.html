<!DOCTYPE html>
<html>
    <head>
        <title>exponential-ish backoff</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <script>
            
            function byid(id) { return document.getElementById(id); }
            
            class acts {
                 
                constructor() {
                    this.tfac  = 0.1;
                    this.limit = 4000;
                    this.thepow = 3; // 1.3 seems good for live
                    
                    this.actv = [];
                    this.doit();
                }
        
                limitf() { return this.tfac * this.limit; }
        
                doit() {
                    const now = acts.now();
                    this.actv.push(now);
                    this.okat = this.okatf();
                    console.log(now);
                    this.seti();
                 }
                
                req() {
                    const now = acts.now();
                    this.okat = this.okatf(now);
                    if (now >= this.okat) this.doit();
                    else this.seti();

                    
                }
                
                okatf(now) {
                    let r;
                    if (this.actv.length > 0) r = this.okatfona(now);
                    else r = now;
                    return r;
                }
                
                intfromi(i) {
                    const pow = this.thepow;
                    const v10 = this.limitf() - pow + Math.pow(pow, i);
                    return v10;
                }
        
                okatfona(now) {
                    const len  = this.actv.length;
                    const v10 = this.intfromi(len);
                    const ev10 = this.actv[len - 1] + v10;
                    
                    // if (len > 2) 
         
         /*
                    const self = this;
       
                    let breakl = false;
                    const cmp = this.intfromi(len+1) * (len + 1); // 
                    
                    if (len > 2 && 0)
                    this.actv.forEach(function(v) {
                            if (breakl) return;
                            if (v + cmp <= now) {
                                const s = self.actv.shift();
                                if (s !== v) breakl = true;
                            }
                        }); */
                    return ev10;
                 
                }
                
                seti() {
                    const self = this;
                    this.cleari();
                    this.setio = setInterval(function() { self.out10(self); }, 53);
                }
                
                cleari() {
                    if (this.setio) clearInterval(this.setio);                    
                }

                static now() { return new Date().getTime(); }
                
                out10(oin) {
                    const d = oin.okat - acts.now();
                    if (d > 0) byid('okate').innerHTML = d;
                    else       {
                        byid('okate').innerHTML = 'OK';
                        oin.cleari();
                    }
                }
                
            }
            
            var GAO = false;
            window.onload = function() { GAO = new acts(); }
        </script>
        
    </head>
    <body>
        <div><button onclick='GAO.req();'>doit</button></div>
        <div id='okate'></div>
    </body>
</html>
