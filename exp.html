<!DOCTYPE html>
<html>
    <head>
        <title>exponential-ish backoff</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <script>
            
            function byid(id) { return document.getElementById(id); }
            
            class acts {
                 
                constructor() {
                    this.tfac  = 0.05;
                    this.limit = 4000;
                    this.actv = [];
                    this.doit();
                }
        
                limitf() { return this.tfac * this.limit; }
        
                doit() {
                    const now = acts.now();
                    this.actv.push(now);
                    this.okat = this.okatf();
                    console.log(now);
                    this.seti();
                 }
                
                mgacts() { 
                    // this.actv = []; 
                }
                
                
                req() {
                    const now = acts.now();
                    this.okat = this.okatf(now);
                    if (now >= this.okat) this.doit();
                    else this.seti();

                    
                }
                
                okatf(now) {
                    let r;
                    if (this.actv.length > 0) r = this.okatfona();
                    else r = now;
                    return r;
                }
                
                okatfona() {
                    const pow = 1.3;

                    const v10 = this.limitf() - pow + Math.pow(pow, this.actv.length);
                    const v20 = Math.round(v10);
                    const ev10 = this.actv[this.actv.length - 1] + v20;
                    return ev10;
                 
                }
                
                seti() {
                    const self = this;
                    this.cleari();
                    this.setio = setInterval(function() { self.out10(self); }, 53);
                }
                
                cleari() {
                    if (this.setio) clearInterval(this.setio);                    
                }

                static now() { return new Date().getTime(); }
                
                out10(oin) {
                    const d = oin.okat - acts.now();
                    if (d > 0) byid('okate').innerHTML = d;
                    else       {
                        byid('okate').innerHTML = 'OK';
                        oin.cleari();
                        oin.mgacts();
                    }
                }
                
            }
            
            var GAO = false;
            window.onload = function() { GAO = new acts(); }
        </script>
        
    </head>
    <body>
        <div><button onclick='GAO.req();'>doit</button></div>
        <div id='okate'></div>
    </body>
</html>
