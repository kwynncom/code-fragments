<!DOCTYPE html>
<html>
    <head>
        <title>exponential-ish backoff</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <script>
            
            function byid(id) { return document.getElementById(id); }
            
            class acts {
                constructor() {
                    this.tfac  = 0.7;
                    this.limit = 4000;
                    this.actv = [];
                    this.doit();
                }
                
                doit() {
                    this.actv.push(acts.now());
                    console.log('doit');
                    this.okat = this.okatf();
                    this.seti();
                    this.out10();
                    // this.mgacts();
                }
                
                mgacts() { this.actv = []; }
                
                
                req() {
                    if (this.actv.length === 0) this.doit();

                    
                }
                
                okatf() {
                    let r;
                    const now = acts.now();
                    if (this.actv.length > 0) r = now + this.limit * this.tfac;
                    else r = now;
                    return r;
                }
                
                seti() {
                    const self = this;
                    this.cleari();
                    this.setio = setInterval(function() { self.out20(self); }, 53);
                }
                
                cleari() {
                    if (this.setio) clearInterval(this.setio);                    
                }

                static now() { return new Date().getTime(); }
                
                out10() {
                    const self = this;
                }
                
                out20(oin) {
                    const d = oin.okat - acts.now();
                    if (d > 0) byid('okate').innerHTML = d;
                    else       {
                        byid('okate').innerHTML = 'OK';
                        oin.cleari();
                        oin.mgacts();
                    }
                }
                
            }
            
            var GAO = false;
            window.onload = function() { GAO = new acts(); }
        </script>
        
    </head>
    <body>
        <div><button onclick='GAO.req();'>doit</button></div>
        <div id='okate'></div>
    </body>
</html>
